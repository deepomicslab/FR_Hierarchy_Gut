# Script description and environment 

## R package required

effsize  
ggplot2  
ggpubr  
svglite  


## Source code install with Conda environment
test in conda 25.1.1
```
git clone https://github.com/deepomicslab/FR_Hierarchy_Gut
cd FR_Hierarchy_Gut/
conda create -n meta_fr python=3.8
conda activate meta_fr
```

```
pip install networkx==2.8.7
pip install ipykernel==5.3.4
pip install ipython==8.12.3
pip install ipython-genutils==0.2.0
pip install matplotlib
pip install pandas==1.1.3
pip install statsmodels==0.14.0
pip install svglib
pip install scikit-learn==1.1.2
pip install scikit-learn-extra==0.2.0
pip install scikit-network==0.27.1
pip install scipy==1.10.1
pip install seaborn==0.12.0
pip install reportlab==3.6.12
pip install lifelines==0.27.8
pip install cliffs-delta
pip install pyseat
pip install numpy==1.22.4
pip install pandas==1.5.2
python -m ipykernel install --user --name meta_fr_linux --display-name "Python (meta_fr)"
```

On your jupyter notebook, choose kernel ```Python (meta_fr)```

## Package requirement  

PySEAT may have conflict with numpy version. We recommand: numpy = 1.22.4 and pyseat = 0.0.1.3

To reproduce the result, first please download and unzip data.zip to /data directory.

If you want to start the analysis from GCN, please run /script_procedure/step1_compute_distance first to compute distance matrix of GCN. This may take some time. To save time, you can directly use sp_d.tsv in /data directory which is preproduced by step1_compute_distance.

Prior structure is generated by scripts in /script_GCN_d3/GCN_tree, please run this script before FMT, NSCLC, Anti_analysis, NSCLC which depend on the prior sturcture.

## input: following files (can be found at data/)  

**&ensp;metadata.tsv**(metadata from GutMeta, disease should be in the header for phenotype comparison)  
**&ensp;abd.tsv** (header: species, index: sample name)  
read by abd_profile.input_profile()  
**&ensp;GCN.tsv** (header: KO, index: species)  
read by GCN.input_GCN()  

<font color="red">We highly recommend running the scripts in the directory sequentially in the following order.</font>

## script of NAFLD (script_NAFLD)  
A quick start of FR hierarchical structure.  
1. step0_NAFLD  
An example of constructing personalized FR netowrk, hierarchical tree, keystone speceis/cluster and comparing keyston clusters of taxa on NAFLD dataset.   

2. step0.5_draw_NAFLD  
Plot networks of NASH and health dataset.  


## script of personalized FR procedure （script_procedure）  
 
1. step1_compute_distance  
An example of computing taxa distance and KO distance from GCN.
  
2. <span id="pheno_anlaysis">step2_cluster_analysis</span>  
An example of analyzing keystone cluster and keystone taxon for metagenomics abundance profiles in cMD by constructing posterior structure.  

3. step3_keystone_summary  
Summarize the keystone species.  

4. utils  

    **a. log_effect**  
    Compute and compare the distribution of personalized FR network before and after log rescalen and normalization.

    **b. nestedness_experiment**  
    An example to test the nestedness compared with NULL experiments of personalized FR.

    **c. evaluation**  
    An example to evaluate the feature of GCN.  

5. step2.5_draw_network  
Scripts used to plot personalized FR network for disease and health group.  

## <span id="abd">script of taxonomy abundance difference (script_abundance_check)</span>  

Check the abundance difference for each taxon (including NAFLD 16s OTU).  


## script of prior GCN structure (script_GCN_d3)  

1. <span id="tree">GCN_tree</span>  
Make prior GCN tree structure.  

2. SE_diff / NFR_diff  
Check SE/nFR difference of disease and health group.  

3. distribution_se  
Plot SE distribution for disease and health group.  

## script of completeness (script_completeness)  

1. completeness  
Compute the module completeness of each taxon (including NAFLD 16s OTU).

2. test_diff  
Test completeness enrichment based one the GCN prior GCN structure and **should be used after GCN_tree script in script_GCN_d3**


## script of FMT (script_FMT)  

[**GCN_tree result is required**](#tree)  

Scripts related to two FMT dataset analysis.

1. analysis_se*  
Mutiple regression on SE value, days after FMT and fraction at each cluster/super-cluster.  

2. analysis_nfr*  
Mutiple regression on nFR, days after FMT and fraction at each cluster/super-cluster.

3. analysis_fr*  
Mutiple regression on FR, days after FMT and fraction at each cluster/super-cluster.

4. compute_fr*  
Compute FR at each cluster/super-cluster for each timepoint.

5. root_*  
Mutiple regression on FR/nFR/SE, days after FMT and fraction only at root.

## script of Antibiotic treatment (script_Anti_analysis)

[**GCN_tree result is required**](#tree)  

1. analysis_se/analysis_nfr  
Check SE/nFR difference of control and exposed group at each clsuter/super-cluter.  

2. merge  
Merge and plot the difference test result of nFR and SE in control and exposed group.  

## script of NSCLC (script_NSCLC)  

1. SE  
Test difference of SE between response group and non-response group at each cluster/super-cluster and compute FR S score for each sample.

2. sig_SE  
Test difference of SE between response group and non-response group at SIG1/SIG2 clsuter raised in original study and compute S score for each sample.

3. distribution  
Plot SE distribution for response group and non-response group.  

4. combination  
Compute combined S score for each sample.

5. The r script
Used to produce the analysis in original study and is provided by https://github.com/valerioiebba/TOPOSCORE/tree/main.  

## plot keystone graph (script_keystone_graph)  

[**GCN_tree result is required**](#tree)  
[**abundance difference result is required**](#abd)  
[**personalized FR procedure is required**](#pheno_anlaysis)  

1. run.ipynb  
Plot keystone result of phenotype datasets.

## script of eigenspecies analysis (script_eigen_graph_preservation)  

[**GCN_tree result is required**](#tree)  

1. run.ipynb  
Find eigen species and plot the result.

## script to predict disease (script_predict)  

[**GCN_tree result and SE values are required**](#tree)  

1. CRC_recurrent_ROC.ipynb  
Predict CRC by LODO.

2. IBD_recurrent_ROC.ipynb  
Predict IBD by LODO.

3. IBD_ROC.ipynb  
Predict IBD by cross-validation.
